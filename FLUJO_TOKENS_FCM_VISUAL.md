# ๐จ Flujo Visual: Tokens FCM

## ๐ Flujo Actual (Con Problema)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    USUARIO EN LA APP                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Profile > Configuraciรณn de Cuenta > Activar Notificacionesโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              AccountSettings.tsx (lรญnea 115)                โ
โ         handleToggleNotifications() se ejecuta              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           notificationService.requestPermission()           โ
โ              โ Permiso concedido                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      notificationService.getAndSaveToken(currentUserId)     โ
โ              โ Token FCM obtenido                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         notificationService.saveTokenToFirestore()          โ
โ              โ ยฟSe guarda el token?                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
                    โโโโโโโโโดโโโโโโโโ
                    โ               โ
                    โผ               โผ
            โโโโโโโโโโโโโ   โโโโโโโโโโโโโ
            โ โ รxito  โ   โ โ Error  โ
            โ (Esperado)โ   โ (Actual)  โ
            โโโโโโโโโโโโโ   โโโโโโโโโโโโโ
                    โ               โ
                    โผ               โผ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
        โ Token guardado  โ โ Token NO        โ
        โ en Firestore    โ โ guardado        โ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
                    โ               โ
                    โผ               โผ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
        โ Colecciรณn       โ โ Colecciรณn       โ
        โ fcmTokens       โ โ fcmTokens       โ
        โ EXISTE          โ โ NO EXISTE       โ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
                    โ               โ
                    โผ               โผ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
        โ Cloud Functions โ โ Cloud Functions โ
        โ pueden enviar   โ โ NO pueden       โ
        โ notificaciones  โ โ enviar          โ
        โโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ
```

## ๐ Puntos de Falla Posibles

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PUNTO DE FALLA #1                        โ
โ              Service Worker No Registrado                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Sรญntoma: Token FCM no se obtiene                           โ
โ Soluciรณn: Verificar firebase-messaging-sw.js               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PUNTO DE FALLA #2                        โ
โ                  VAPID Key Incorrecta                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Sรญntoma: Error al obtener token                            โ
โ Soluciรณn: Verificar VAPID key en Firebase Console         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PUNTO DE FALLA #3                        โ
โ              Reglas de Firestore Bloqueando                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Sรญntoma: Error "permission-denied"                         โ
โ Soluciรณn: Verificar reglas en firestore.rules             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PUNTO DE FALLA #4                        โ
โ                  Error Silencioso                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Sรญntoma: No hay error visible, pero no se guarda           โ
โ Soluciรณn: Agregar logging y verificaciรณn                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โ Flujo Esperado (Despuรฉs de la Soluciรณn)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    USUARIO EN LA APP                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Activar Notificaciones                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              โ Permiso Concedido                           โ
โ         Notification.permission === "granted"               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         โ Service Worker Registrado                        โ
โ      navigator.serviceWorker.register()                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              โ Token FCM Obtenido                          โ
โ         getToken(messaging, { vapidKey })                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         โ Token Guardado en Firestore                      โ
โ      setDoc(doc(db, 'fcmTokens', userId), {...})           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              โ Token Verificado                            โ
โ      getDoc(doc(db, 'fcmTokens', userId))                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         โ Notificaciรณn de Prueba Enviada                   โ
โ      new Notification("Notificaciones activas!")           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              โ Usuario Recibe Notificaciรณn                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Estructura de Datos en Firestore

### Colecciรณn: `fcmTokens`

```
fcmTokens/
โโโ {userId1}/
โ   โโโ token: "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9..."
โ   โโโ userId: "abc123"
โ   โโโ createdAt: Timestamp(2026-02-06 10:30:00)
โ   โโโ updatedAt: Timestamp(2026-02-06 10:30:00)
โ   โโโ platform: "web"
โ   โโโ userAgent: "Mozilla/5.0..."
โ
โโโ {userId2}/
โ   โโโ token: "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9..."
โ   โโโ userId: "def456"
โ   โโโ createdAt: Timestamp(2026-02-06 11:00:00)
โ   โโโ updatedAt: Timestamp(2026-02-06 11:00:00)
โ   โโโ platform: "web"
โ   โโโ userAgent: "Mozilla/5.0..."
โ
โโโ {userId3}/
    โโโ token: "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9..."
    โโโ userId: "ghi789"
    โโโ createdAt: Timestamp(2026-02-06 12:00:00)
    โโโ updatedAt: Timestamp(2026-02-06 12:00:00)
    โโโ platform: "web"
    โโโ userAgent: "Mozilla/5.0..."
```

## ๐ Flujo de Notificaciones (Despuรฉs de Guardar Token)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              USUARIO A ENVรA MENSAJE                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Cloud Function: onMessageCreated                    โ
โ              Se activa automรกticamente                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Leer token de Firestore: fcmTokens/{userId}           โ
โ              โ Token encontrado                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Enviar notificaciรณn push con FCM                    โ
โ      admin.messaging().send({ token, notification })       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              USUARIO B RECIBE NOTIFICACIรN                  โ
โ         "Nuevo mensaje de Usuario A"                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Comparaciรณn: Antes vs Despuรฉs

### โ ANTES (Problema)
```
Usuario activa notificaciones
    โ
Permiso concedido โ
    โ
Token obtenido โ
    โ
Token NO se guarda โ
    โ
Colecciรณn fcmTokens NO existe โ
    โ
Cloud Functions NO pueden enviar โ
    โ
Usuario NO recibe notificaciones โ
```

### โ DESPUรS (Soluciรณn)
```
Usuario activa notificaciones
    โ
Permiso concedido โ
    โ
Token obtenido โ
    โ
Token guardado en Firestore โ
    โ
Token verificado โ
    โ
Colecciรณn fcmTokens existe โ
    โ
Cloud Functions pueden enviar โ
    โ
Usuario recibe notificaciones โ
```

## ๐๏ธ Herramienta de Diagnรณstico

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          test-fcm-token-debug.html                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  1. Verificar Soporte del Sistema                          โ
โ     โโ Notification API          โ                        โ
โ     โโ Service Worker            โ                        โ
โ     โโ Push Manager              โ                        โ
โ     โโ HTTPS                     โ                        โ
โ                                                             โ
โ  2. Verificar Autenticaciรณn                                โ
โ     โโ Usuario autenticado       โ                        โ
โ                                                             โ
โ  3. Solicitar Permiso                                      โ
โ     โโ Permiso concedido         โ                        โ
โ                                                             โ
โ  4. Obtener Token FCM                                      โ
โ     โโ Service Worker registrado โ                        โ
โ     โโ Token obtenido            โ                        โ
โ                                                             โ
โ  5. Guardar Token                                          โ
โ     โโ Token guardado            โ                        โ
โ                                                             โ
โ  6. Verificar Firestore                                    โ
โ     โโ Token encontrado          โ                        โ
โ                                                             โ
โ  ๐ Logs Detallados                                        โ
โ     โโ Ver cada paso en tiempo real                       โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Checklist Visual

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CHECKLIST DE VERIFICACIรN                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  [ ] Navegador soporta notificaciones push                 โ
โ  [ ] Usuario estรก autenticado                              โ
โ  [ ] Permiso de notificaciones concedido                   โ
โ  [ ] Service Worker registrado                             โ
โ  [ ] Token FCM obtenido                                    โ
โ  [ ] Token guardado en Firestore                           โ
โ  [ ] Token verificado en Firestore                         โ
โ  [ ] Colecciรณn fcmTokens existe                            โ
โ  [ ] Documento con userId existe                           โ
โ  [ ] Cloud Functions pueden leer tokens                    โ
โ  [ ] Notificaciones llegan correctamente                   โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Creado**: 6 de febrero de 2026  
**Propรณsito**: Visualizaciรณn del flujo de tokens FCM
