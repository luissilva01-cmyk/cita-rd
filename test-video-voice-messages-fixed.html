<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba: Mensajes de Voz y Video - CORREGIDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-rose-50 to-pink-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">
                ‚úÖ Mensajes de Voz y Video - CORREGIDO
            </h1>
            <p class="text-slate-600">
                Prueba de videomensajes y mensajes de voz con Firebase Storage
            </p>
            <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-green-800 font-medium">üéâ Problema Resuelto:</p>
                <ul class="text-green-700 text-sm mt-2 space-y-1">
                    <li>‚úÖ C√≥digo de producci√≥n activado en voiceMessageService.ts</li>
                    <li>‚úÖ Storage Rules desplegadas</li>
                    <li>‚úÖ URLs p√∫blicas de Firebase Storage (no m√°s blob: locales)</li>
                    <li>‚úÖ Archivos compartibles entre usuarios</li>
                </ul>
            </div>
        </div>

        <!-- Diagn√≥stico del Problema -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üîç Diagn√≥stico</h2>
            
            <div class="space-y-4">
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Problema Anterior:</h3>
                    <ul class="text-red-700 text-sm space-y-1">
                        <li>‚Ä¢ uploadVoiceMessage usaba URLs locales (blob:)</li>
                        <li>‚Ä¢ C√≥digo de Firebase Storage estaba COMENTADO</li>
                        <li>‚Ä¢ URLs solo funcionaban en el navegador que las cre√≥</li>
                        <li>‚Ä¢ Receptor no pod√≠a ver/escuchar los mensajes</li>
                    </ul>
                </div>

                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Soluci√≥n Implementada:</h3>
                    <ul class="text-green-700 text-sm space-y-1">
                        <li>‚Ä¢ Descomentado c√≥digo de Firebase Storage</li>
                        <li>‚Ä¢ Archivos se suben a: voice_messages/{chatId}/{senderId}_{timestamp}.webm</li>
                        <li>‚Ä¢ URLs p√∫blicas compartibles entre usuarios</li>
                        <li>‚Ä¢ Storage Rules desplegadas con l√≠mite de 50MB</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- C√≥digo Antes vs Despu√©s -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üìù C√≥digo Antes vs Despu√©s</h2>
            
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Antes -->
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Antes (NO funcionaba):</h3>
                    <pre class="text-xs text-red-700 overflow-x-auto"><code>// TEMPORAL: URL local
const localUrl = URL.createObjectURL(audioBlob);
await new Promise(resolve => setTimeout(resolve, 500));
return localUrl; // ‚ùå Solo funciona localmente

/* C√≥digo de producci√≥n COMENTADO
const fileName = `voice_messages/...`;
const storageRef = ref(storage, fileName);
const snapshot = await uploadBytes(...);
const downloadURL = await getDownloadURL(...);
return downloadURL;
*/</code></pre>
                </div>

                <!-- Despu√©s -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Despu√©s (Funciona):</h3>
                    <pre class="text-xs text-green-700 overflow-x-auto"><code>// Subir a Firebase Storage
const fileName = `voice_messages/${chatId}/${senderId}_${Date.now()}.webm`;
const storageRef = ref(storage, fileName);

const snapshot = await uploadBytes(storageRef, audioBlob);
const downloadURL = await getDownloadURL(snapshot.ref);

return downloadURL; // ‚úÖ URL p√∫blica compartible</code></pre>
                </div>
            </div>
        </div>

        <!-- Storage Rules -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üîí Storage Rules Desplegadas</h2>
            
            <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                <pre class="text-sm text-slate-700 overflow-x-auto"><code>match /voice_messages/{chatId}/{fileName} {
  // Permitir lectura a usuarios autenticados
  allow read: if request.auth != null;
  
  // Permitir escritura a usuarios autenticados
  allow write: if request.auth != null
               && request.resource.size < 50 * 1024 * 1024 // M√°ximo 50MB
               && (request.resource.contentType.matches('audio/.*') 
                   || request.resource.contentType.matches('video/.*'));
  
  // Permitir eliminaci√≥n a usuarios autenticados
  allow delete: if request.auth != null;
}</code></pre>
            </div>

            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-blue-800 font-medium">üìã Comando de Despliegue:</p>
                <pre class="text-blue-700 text-sm mt-2"><code>cd cita-rd
firebase deploy --only storage

‚úÖ storage: released rules storage.rules to firebase.storage
‚úÖ Deploy complete!</code></pre>
            </div>
        </div>

        <!-- Flujo Completo -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üîÑ Flujo Completo</h2>
            
            <div class="space-y-4">
                <!-- Env√≠o -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-2">üì§ Env√≠o de Mensaje:</h3>
                    <ol class="text-purple-700 text-sm space-y-1 list-decimal list-inside">
                        <li>Usuario presiona bot√≥n de micr√≥fono/c√°mara</li>
                        <li>Se solicitan permisos</li>
                        <li>MediaRecorder inicia grabaci√≥n</li>
                        <li>Usuario detiene grabaci√≥n</li>
                        <li>Se crea Blob del archivo</li>
                        <li><strong>Se sube a Firebase Storage</strong> (antes era URL local)</li>
                        <li>Se obtiene URL p√∫blica</li>
                        <li>Se env√≠a mensaje con URL</li>
                        <li>Se guarda en Firestore</li>
                    </ol>
                </div>

                <!-- Recepci√≥n -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-2">üì• Recepci√≥n de Mensaje:</h3>
                    <ol class="text-blue-700 text-sm space-y-1 list-decimal list-inside">
                        <li>Listener de Firestore detecta nuevo mensaje</li>
                        <li>Se obtiene URL del archivo</li>
                        <li><strong>URL es p√∫blica de Firebase Storage</strong> (antes era blob local)</li>
                        <li>Componente VoiceMessage/VideoMessage carga el archivo</li>
                        <li>Usuario puede reproducir</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Funcionalidades -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üéØ Funcionalidades Operativas</h2>
            
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Mensajes de Voz -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-2">üé§ Mensajes de Voz:</h3>
                    <ul class="text-green-700 text-sm space-y-1">
                        <li>‚úÖ Grabaci√≥n con MediaRecorder</li>
                        <li>‚úÖ Subida a Firebase Storage</li>
                        <li>‚úÖ URL p√∫blica compartible</li>
                        <li>‚úÖ Reproducci√≥n para todos</li>
                        <li>‚úÖ L√≠mite: 50MB</li>
                        <li>‚úÖ Formato: audio/webm</li>
                    </ul>
                </div>

                <!-- Videomensajes -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-2">üìπ Videomensajes:</h3>
                    <ul class="text-purple-700 text-sm space-y-1">
                        <li>‚úÖ Grabaci√≥n con c√°mara y micr√≥fono</li>
                        <li>‚úÖ Vista previa (efecto espejo)</li>
                        <li>‚úÖ L√≠mite de 30 segundos</li>
                        <li>‚úÖ Subida a Firebase Storage</li>
                        <li>‚úÖ URL p√∫blica compartible</li>
                        <li>‚úÖ Reproducci√≥n para todos</li>
                        <li>‚úÖ Controles play/pause</li>
                        <li>‚úÖ Control de volumen</li>
                        <li>‚úÖ L√≠mite: 50MB</li>
                        <li>‚úÖ Formato: video/webm</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Costos -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üí∞ Costos Estimados</h2>
            
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-bold text-yellow-800 mb-2">Firebase Storage (Plan Blaze):</h3>
                <ul class="text-yellow-700 text-sm space-y-1">
                    <li>‚Ä¢ Almacenamiento: $0.026 por GB/mes</li>
                    <li>‚Ä¢ Descarga: $0.12 por GB</li>
                    <li>‚Ä¢ Subida: Gratis</li>
                </ul>
                
                <div class="mt-4 p-3 bg-yellow-100 rounded">
                    <p class="font-bold text-yellow-900 mb-1">Estimaci√≥n para 1000 usuarios activos:</p>
                    <ul class="text-yellow-800 text-sm space-y-1">
                        <li>‚Ä¢ 10 mensajes/d√≠a por usuario</li>
                        <li>‚Ä¢ Promedio 2MB por mensaje</li>
                        <li>‚Ä¢ Total: 600GB/mes</li>
                        <li>‚Ä¢ <strong>Costo almacenamiento: ~$15/mes</strong></li>
                        <li>‚Ä¢ <strong>Costo descarga: ~$144/mes</strong></li>
                        <li>‚Ä¢ <strong>Total: ~$160/mes</strong></li>
                    </ul>
                </div>
            </div>

            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-bold text-blue-800 mb-2">üéØ Optimizaciones Recomendadas:</h3>
                <ul class="text-blue-700 text-sm space-y-1">
                    <li>‚Ä¢ Comprimir videos antes de subir (2MB ‚Üí 500KB)</li>
                    <li>‚Ä¢ Eliminar mensajes antiguos (>30 d√≠as)</li>
                    <li>‚Ä¢ Usar CDN para reducir costos de descarga</li>
                    <li>‚Ä¢ Implementar l√≠mites por usuario (50 mensajes/d√≠a)</li>
                </ul>
            </div>
        </div>

        <!-- Pruebas -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üß™ Pruebas Recomendadas</h2>
            
            <div class="space-y-4">
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-slate-800 mb-2">1. Mensajes de Voz:</h3>
                    <ul class="text-slate-700 text-sm space-y-1">
                        <li>‚è≥ Grabar mensaje de voz</li>
                        <li>‚è≥ Verificar subida a Firebase Storage</li>
                        <li>‚è≥ Verificar que receptor puede escucharlo</li>
                        <li>‚è≥ Probar en diferentes navegadores</li>
                        <li>‚è≥ Probar en m√≥vil</li>
                    </ul>
                </div>

                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-slate-800 mb-2">2. Videomensajes:</h3>
                    <ul class="text-slate-700 text-sm space-y-1">
                        <li>‚è≥ Grabar videomensaje</li>
                        <li>‚è≥ Verificar vista previa durante grabaci√≥n</li>
                        <li>‚è≥ Verificar subida a Firebase Storage</li>
                        <li>‚è≥ Verificar que receptor puede verlo</li>
                        <li>‚è≥ Probar controles de play/pause</li>
                        <li>‚è≥ Probar control de volumen</li>
                        <li>‚è≥ Probar l√≠mite de 30 segundos</li>
                        <li>‚è≥ Probar en diferentes navegadores</li>
                        <li>‚è≥ Probar en m√≥vil</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="bg-gradient-to-r from-rose-500 to-pink-500 rounded-2xl shadow-xl p-8 text-white">
            <h2 class="text-2xl font-bold mb-4">üöÄ C√≥mo Probar</h2>
            <ol class="space-y-2 text-sm">
                <li><strong>1.</strong> Aseg√∫rate de que el servidor est√© corriendo: <code class="bg-white/20 px-2 py-1 rounded">npm run dev</code></li>
                <li><strong>2.</strong> Abre la app en dos navegadores diferentes (o dos ventanas de inc√≥gnito)</li>
                <li><strong>3.</strong> Inicia sesi√≥n con dos usuarios diferentes</li>
                <li><strong>4.</strong> Crea un match entre ellos</li>
                <li><strong>5.</strong> En el chat, prueba enviar un mensaje de voz</li>
                <li><strong>6.</strong> Verifica que el otro usuario puede escucharlo</li>
                <li><strong>7.</strong> Prueba enviar un videomensaje</li>
                <li><strong>8.</strong> Verifica que el otro usuario puede verlo</li>
                <li><strong>9.</strong> Revisa la consola para ver los logs de subida</li>
                <li><strong>10.</strong> Verifica en Firebase Console que los archivos se subieron</li>
            </ol>
        </div>
    </div>
</body>
</html>
