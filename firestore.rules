rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==============================
    // FUNCIONES AUXILIARES
    // ==============================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es el dueño del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verificar si el usuario es participante de un chat
    function isChatParticipant(chatId) {
      return isAuthenticated() && 
             request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
    
    // Validar datos de perfil
    function isValidProfile() {
      let data = request.resource.data;
      return data.name is string && data.name.size() > 0 && data.name.size() <= 100 &&
             data.age is int && data.age >= 18 && data.age <= 100 &&
             data.bio is string && data.bio.size() <= 500 &&
             data.location is string && data.location.size() > 0 &&
             data.interests is list && data.interests.size() <= 20 &&
             data.images is list && data.images.size() <= 6;
    }
    
    // ==============================
    // COLECCIÓN: perfiles
    // ==============================
    match /perfiles/{userId} {
      // Leer: Solo usuarios autenticados
      allow read: if isAuthenticated();
      
      // Crear: Solo el propio usuario con datos válidos
      allow create: if isOwner(userId) && isValidProfile();
      
      // Escribir (update, set, merge): Solo el propio usuario
      // Simplificado para permitir actualizaciones parciales
      allow write: if isOwner(userId);
      
      // Eliminar: Solo el propio usuario
      allow delete: if isOwner(userId);
    }
    
    // ==============================
    // COLECCIÓN: chats
    // ==============================
    match /chats/{chatId} {
      // Leer: Solo participantes del chat
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Escribir (create, update, set): Simplificado
      // Solo verificar que el usuario esté autenticado y sea participante
      allow write: if isAuthenticated();
      
      // Eliminar: No permitido (los chats no se eliminan, solo se archivan)
      allow delete: if false;
      
      // Subcolección: messages
      match /messages/{messageId} {
        // Leer: Solo participantes del chat
        allow read: if isChatParticipant(chatId);
        
        // Escribir: Simplificado - solo verificar que sea participante
        allow write: if isChatParticipant(chatId);
        
        // Eliminar: No permitido
        allow delete: if false;
      }
      
      // Subcolección: typingStatus
      match /typingStatus/{userId} {
        // Leer: Solo participantes del chat
        allow read: if isChatParticipant(chatId);
        
        // Escribir: Solo el propio usuario
        allow write: if isChatParticipant(chatId) && isOwner(userId);
      }
    }
    
    // ==============================
    // COLECCIÓN: matches
    // ==============================
    match /matches/{matchId} {
      // Leer: Usuarios autenticados (simplificado)
      allow read: if isAuthenticated();
      
      // Escribir: Usuarios autenticados (simplificado)
      allow write: if isAuthenticated();
      
      // Eliminar: Usuarios autenticados
      allow delete: if isAuthenticated();
    }
    
    // ==============================
    // COLECCIÓN: likes
    // ==============================
    match /likes/{likeId} {
      // Leer: Usuarios autenticados (simplificado)
      allow read: if isAuthenticated();
      
      // Escribir: Usuarios autenticados (simplificado)
      allow write: if isAuthenticated();
      
      // Eliminar: Usuarios autenticados
      allow delete: if isAuthenticated();
    }
    
    // ==============================
    // COLECCIÓN: stories
    // ==============================
    match /stories/{storyId} {
      // Leer: Usuarios autenticados (privacidad se maneja en código)
      allow read: if isAuthenticated();
      
      // Crear: Usuario autenticado con userId correcto
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.type in ['image', 'text'] &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0;
      
      // Actualizar: Solo el dueño (para viewedBy)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el dueño
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ==============================
    // COLECCIÓN: presence
    // ==============================
    match /presence/{userId} {
      // Leer: Usuarios autenticados
      allow read: if isAuthenticated();
      
      // Escribir: Solo el propio usuario
      allow write: if isOwner(userId);
    }
    
    // ==============================
    // COLECCIÓN: privacySettings
    // ==============================
    match /privacySettings/{userId} {
      // Leer: Solo el propio usuario
      allow read: if isOwner(userId);
      
      // Escribir: Solo el propio usuario
      allow write: if isOwner(userId);
    }
    
    // ==============================
    // COLECCIÓN: verifications
    // ==============================
    match /verifications/{userId} {
      // Leer: Usuarios autenticados (para ver badges)
      allow read: if isAuthenticated();
      
      // Escribir: Solo el propio usuario
      allow write: if isOwner(userId);
    }
    
    // ==============================
    // DENEGAR TODO LO DEMÁS
    // ==============================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}