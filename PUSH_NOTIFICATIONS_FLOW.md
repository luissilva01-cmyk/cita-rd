# ğŸ”” Push Notifications - Flujo Visual

## ğŸ“± Flujo Completo de Notificaciones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASE 1: SOLICITUD DE PERMISOS                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario inicia sesiÃ³n
        â”‚
        â–¼
Completa su perfil (fotos, bio, ubicaciÃ³n)
        â”‚
        â–¼
Espera 3 segundos
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NotificationPermissionPrompt         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”” Activa las Notificaciones   â”‚  â”‚
â”‚  â”‚    No te pierdas ningÃºn match  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Recibe notificaciones cuando:  â”‚  â”‚
â”‚  â”‚ ğŸ’• Likes y super likes         â”‚  â”‚
â”‚  â”‚ ğŸ’¬ Nuevos mensajes             â”‚  â”‚
â”‚  â”‚ â­ Nuevos matches              â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚ [Ahora no]  [ğŸ”” Activar]      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
Usuario hace clic en "Activar"
        â”‚
        â–¼
Navegador pide permiso nativo
        â”‚
        â”œâ”€â”€â”€ Usuario acepta â”€â”€â”€â”
        â”‚                      â”‚
        â”‚                      â–¼
        â”‚              Se genera FCM token
        â”‚                      â”‚
        â”‚                      â–¼
        â”‚              Token se guarda en Firestore
        â”‚              (colecciÃ³n: fcmTokens)
        â”‚                      â”‚
        â”‚                      â–¼
        â”‚              NotificaciÃ³n de prueba
        â”‚              "ğŸ‰ Las notificaciones estÃ¡n funcionando!"
        â”‚
        â””â”€â”€â”€ Usuario rechaza â”€â”€â”€â”
                                â”‚
                                â–¼
                        Se guarda en localStorage
                        (no volver a preguntar)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASE 2: ENVÃO DE NOTIFICACIONES              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EVENTO: Usuario A envÃ­a mensaje a Usuario B
        â”‚
        â–¼
Firestore: Se crea documento en /chats/{chatId}/messages/{messageId}
        â”‚
        â–¼
Cloud Function: sendMessageNotification se activa automÃ¡ticamente
        â”‚
        â”œâ”€â”€â”€ Obtiene informaciÃ³n del chat
        â”‚
        â”œâ”€â”€â”€ Encuentra el receptor (Usuario B)
        â”‚
        â”œâ”€â”€â”€ Obtiene FCM token de Usuario B desde Firestore
        â”‚
        â”œâ”€â”€â”€ Obtiene nombre de Usuario A
        â”‚
        â””â”€â”€â”€ Prepara payload de notificaciÃ³n
                â”‚
                â–¼
        Firebase Cloud Messaging (FCM)
                â”‚
                â–¼
        Entrega notificaciÃ³n al dispositivo de Usuario B
                â”‚
                â”œâ”€â”€â”€ App abierta (foreground) â”€â”€â”€â”
                â”‚                                 â”‚
                â”‚                                 â–¼
                â”‚                    notificationService.ts
                â”‚                    onMessage() muestra notificaciÃ³n
                â”‚
                â””â”€â”€â”€ App cerrada (background) â”€â”€â”€â”
                                                  â”‚
                                                  â–¼
                                    firebase-messaging-sw.js
                                    Service Worker muestra notificaciÃ³n


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASE 3: INTERACCIÃ“N DEL USUARIO              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario ve notificaciÃ³n en su dispositivo
        â”‚
        â–¼
Usuario hace clic en la notificaciÃ³n
        â”‚
        â–¼
Service Worker detecta el click
        â”‚
        â–¼
Determina URL segÃºn tipo de notificaciÃ³n:
        â”‚
        â”œâ”€â”€â”€ Mensaje â†’ /chat/{chatId}
        â”‚
        â”œâ”€â”€â”€ Match â†’ /matches
        â”‚
        â””â”€â”€â”€ Story â†’ /
                â”‚
                â–¼
        Busca ventana abierta de la app
                â”‚
                â”œâ”€â”€â”€ Ventana existe â”€â”€â”€â”
                â”‚                      â”‚
                â”‚                      â–¼
                â”‚              Enfoca ventana
                â”‚              Navega a URL
                â”‚
                â””â”€â”€â”€ No existe ventana â”€â”€â”€â”
                                          â”‚
                                          â–¼
                                  Abre nueva ventana
                                  con la URL correcta
```

---

## ğŸ¯ Tipos de Notificaciones

### 1. NotificaciÃ³n de Mensaje

```
TRIGGER: Nuevo documento en /chats/{chatId}/messages/{messageId}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarÃ­a, 24                       â”‚
â”‚ Hola! Â¿CÃ³mo estÃ¡s? ğŸ˜Š          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLICK â†’ Navega a /chat/{chatId}

PAYLOAD:
{
  notification: {
    title: "MarÃ­a, 24",
    body: "Hola! Â¿CÃ³mo estÃ¡s? ğŸ˜Š",
    icon: "/logo192.png",
    tag: "message"
  },
  data: {
    type: "message",
    chatId: "abc123",
    senderId: "user456",
    senderName: "MarÃ­a"
  }
}
```

### 2. NotificaciÃ³n de Match

```
TRIGGER: Nuevo documento en /chats/{chatId}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‰ Â¡Nuevo Match!                â”‚
â”‚ Â¡Hiciste match con Carlos!     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLICK â†’ Navega a /matches

PAYLOAD:
{
  notification: {
    title: "ğŸ‰ Â¡Nuevo Match!",
    body: "Â¡Hiciste match con Carlos!",
    icon: "/logo192.png",
    tag: "match"
  },
  data: {
    type: "match",
    chatId: "xyz789",
    matchUserId: "user789",
    matchUserName: "Carlos"
  }
}
```

### 3. NotificaciÃ³n de Story

```
TRIGGER: Nuevo documento en /stories/{storyId}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ana publicÃ³ una historia        â”‚
â”‚ Â¡MÃ­rala antes de que desaparezca!â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLICK â†’ Navega a /

PAYLOAD:
{
  notification: {
    title: "Ana publicÃ³ una historia",
    body: "Â¡MÃ­rala antes de que desaparezca!",
    icon: "/logo192.png",
    tag: "story"
  },
  data: {
    type: "story",
    storyId: "story123",
    creatorId: "user321",
    creatorName: "Ana"
  }
}
```

---

## ğŸ”„ Ciclo de Vida del Token FCM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CICLO DE VIDA DEL TOKEN                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario acepta permisos
        â”‚
        â–¼
Se genera token FCM
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore: fcmTokens/{userId}    â”‚
â”‚ {                                 â”‚
â”‚   token: "eXaMpLe...",           â”‚
â”‚   userId: "user123",             â”‚
â”‚   platform: "web",               â”‚
â”‚   userAgent: "Chrome/...",       â”‚
â”‚   createdAt: Timestamp,          â”‚
â”‚   updatedAt: Timestamp           â”‚
â”‚ }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
Token permanece activo
        â”‚
        â”œâ”€â”€â”€ Usuario cierra sesiÃ³n â”€â”€â”€â”
        â”‚                              â”‚
        â”‚                              â–¼
        â”‚                      notificationService.deleteToken()
        â”‚                              â”‚
        â”‚                              â–¼
        â”‚                      Token se marca como deleted
        â”‚                      en Firestore
        â”‚
        â”œâ”€â”€â”€ Token expira â”€â”€â”€â”
        â”‚                    â”‚
        â”‚                    â–¼
        â”‚            FCM genera nuevo token
        â”‚                    â”‚
        â”‚                    â–¼
        â”‚            Se actualiza en Firestore
        â”‚
        â””â”€â”€â”€ Usuario revoca permisos â”€â”€â”€â”
                                         â”‚
                                         â–¼
                                 Token se invalida
                                 No se pueden enviar notificaciones
```

---

## ğŸ—ï¸ Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  App.tsx                                                        â”‚
â”‚    â”‚                                                            â”‚
â”‚    â”œâ”€â”€â”€ NotificationPermissionPrompt.tsx                       â”‚
â”‚    â”‚      â””â”€â”€â”€ notificationService.ts                          â”‚
â”‚    â”‚             â””â”€â”€â”€ Firebase Messaging SDK                   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â””â”€â”€â”€ Service Worker: firebase-messaging-sw.js              â”‚
â”‚           â””â”€â”€â”€ Escucha mensajes en background                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ FCM Token
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FIRESTORE DATABASE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  fcmTokens/{userId}                                            â”‚
â”‚    â””â”€â”€â”€ token, platform, userAgent, timestamps                â”‚
â”‚                                                                 â”‚
â”‚  chats/{chatId}/messages/{messageId}  â—„â”€â”€â”€ Trigger            â”‚
â”‚  chats/{chatId}                       â—„â”€â”€â”€ Trigger            â”‚
â”‚  stories/{storyId}                    â—„â”€â”€â”€ Trigger            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Triggers
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUD FUNCTIONS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  sendMessageNotification()                                      â”‚
â”‚    â””â”€â”€â”€ Obtiene token â†’ EnvÃ­a notificaciÃ³n                    â”‚
â”‚                                                                 â”‚
â”‚  sendMatchNotification()                                        â”‚
â”‚    â””â”€â”€â”€ Obtiene tokens â†’ EnvÃ­a a ambos usuarios               â”‚
â”‚                                                                 â”‚
â”‚  sendStoryNotification()                                        â”‚
â”‚    â””â”€â”€â”€ Obtiene tokens de matches â†’ EnvÃ­a notificaciones      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP Request
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FIREBASE CLOUD MESSAGING (FCM)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Entrega notificaciones a dispositivos                         â”‚
â”‚    â””â”€â”€â”€ Web Push Protocol                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Push Notification
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DISPOSITIVO DEL USUARIO                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ MarÃ­a, 24                       â”‚                          â”‚
â”‚  â”‚ Hola! Â¿CÃ³mo estÃ¡s? ğŸ˜Š          â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Seguridad y Permisos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIRESTORE SECURITY RULES                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

match /fcmTokens/{userId} {
  // Solo el usuario puede leer su propio token
  allow read: if request.auth.uid == userId;
  
  // Solo el usuario puede escribir su propio token
  allow write: if request.auth.uid == userId;
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUD FUNCTIONS PERMISSIONS                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cloud Functions tienen acceso ADMIN a Firestore
  â””â”€â”€â”€ Pueden leer tokens de cualquier usuario
  â””â”€â”€â”€ Pueden enviar notificaciones a cualquier usuario
  â””â”€â”€â”€ Solo se activan por triggers de Firestore (seguro)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VAPID KEY                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VAPID Key se usa para:
  â””â”€â”€â”€ Autenticar solicitudes de FCM desde el frontend
  â””â”€â”€â”€ Identificar la aplicaciÃ³n web
  â””â”€â”€â”€ NO es secreta (puede estar en cÃ³digo frontend)
  â””â”€â”€â”€ Diferente de Server Key (esa SÃ es secreta)
```

---

## ğŸ“Š Flujo de Datos

```
EVENTO â†’ FIRESTORE â†’ CLOUD FUNCTION â†’ FCM â†’ DISPOSITIVO

Ejemplo: Usuario A envÃ­a mensaje a Usuario B

1. Frontend (Usuario A):
   sendMessage(chatId, "Hola!")
        â”‚
        â–¼
2. Firestore:
   /chats/abc123/messages/msg456
   {
     senderId: "userA",
     text: "Hola!",
     timestamp: now()
   }
        â”‚
        â–¼
3. Cloud Function (automÃ¡tico):
   sendMessageNotification()
   - Detecta nuevo mensaje
   - Obtiene chatId: "abc123"
   - Encuentra receptor: "userB"
   - Obtiene token de userB
   - Obtiene nombre de userA: "MarÃ­a"
        â”‚
        â–¼
4. FCM:
   POST https://fcm.googleapis.com/v1/projects/citard-fbc26/messages:send
   {
     message: {
       token: "token_de_userB",
       notification: {
         title: "MarÃ­a, 24",
         body: "Hola!"
       }
     }
   }
        â”‚
        â–¼
5. Dispositivo (Usuario B):
   - Recibe notificaciÃ³n
   - Service Worker la muestra
   - Usuario hace clic
   - Navega a /chat/abc123
```

---

## ğŸ¯ Resumen Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario    â”‚â”€â”€â”€â”€â–¶â”‚   Frontend   â”‚â”€â”€â”€â”€â–¶â”‚  Firestore   â”‚
â”‚  acepta      â”‚     â”‚  genera      â”‚     â”‚  guarda      â”‚
â”‚  permisos    â”‚     â”‚  FCM token   â”‚     â”‚  token       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ Trigger
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dispositivo â”‚â—€â”€â”€â”€â”€â”‚     FCM      â”‚â—€â”€â”€â”€â”€â”‚    Cloud     â”‚
â”‚  muestra     â”‚     â”‚  entrega     â”‚     â”‚  Function    â”‚
â”‚  notificaciÃ³nâ”‚     â”‚  notificaciÃ³nâ”‚     â”‚  envÃ­a       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Fecha:** 4 de Febrero 2026  
**Documento:** Flujo visual de Push Notifications  
**Estado:** âœ… Sistema completo implementado
