<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test - Mensajes de Foto | Ta' Pa' Ti</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  
  <div class="max-w-md mx-auto p-4">
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      
      <!-- Header -->
      <div class="bg-gradient-to-r from-rose-500 to-pink-500 p-4 text-white">
        <h1 class="text-xl font-bold">ğŸ“¸ Test Mensajes de Foto</h1>
        <p class="text-sm opacity-90">Prueba de compresiÃ³n y envÃ­o</p>
      </div>

      <!-- Content -->
      <div class="p-6 space-y-6">
        
        <!-- Selector de archivo -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            Selecciona una imagen
          </label>
          <input 
            type="file" 
            id="fileInput" 
            accept="image/*"
            class="block w-full text-sm text-slate-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-rose-50 file:text-rose-700
              hover:file:bg-rose-100
              cursor-pointer"
          />
        </div>

        <!-- InformaciÃ³n de la imagen -->
        <div id="imageInfo" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4">
          <h3 class="font-bold text-blue-900 mb-2">ğŸ“Š InformaciÃ³n Original</h3>
          <div class="space-y-1 text-sm text-blue-800">
            <p><strong>Nombre:</strong> <span id="fileName"></span></p>
            <p><strong>TamaÃ±o:</strong> <span id="fileSize"></span></p>
            <p><strong>Tipo:</strong> <span id="fileType"></span></p>
            <p><strong>Dimensiones:</strong> <span id="fileDimensions"></span></p>
          </div>
        </div>

        <!-- Preview original -->
        <div id="originalPreview" class="hidden">
          <h3 class="font-bold text-slate-700 mb-2">ğŸ–¼ï¸ Imagen Original</h3>
          <img id="originalImage" class="w-full rounded-xl border border-slate-200" />
        </div>

        <!-- BotÃ³n de procesar -->
        <button 
          id="processBtn"
          class="w-full bg-gradient-to-r from-rose-500 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          ğŸ—œï¸ Comprimir y Convertir
        </button>

        <!-- Resultado -->
        <div id="result" class="hidden bg-green-50 border border-green-200 rounded-xl p-4">
          <h3 class="font-bold text-green-900 mb-2">âœ… Resultado</h3>
          <div class="space-y-1 text-sm text-green-800 mb-3">
            <p><strong>TamaÃ±o final:</strong> <span id="finalSize"></span></p>
            <p><strong>Dimensiones finales:</strong> <span id="finalDimensions"></span></p>
            <p><strong>Calidad:</strong> <span id="finalQuality"></span></p>
            <p><strong>CompresiÃ³n:</strong> <span id="compressionRate"></span></p>
            <p><strong>Base64 length:</strong> <span id="base64Length"></span></p>
          </div>
          
          <h4 class="font-bold text-green-900 mb-2">ğŸ–¼ï¸ Imagen Comprimida</h4>
          <img id="compressedImage" class="w-full rounded-xl border border-green-200 mb-3" />
          
          <button 
            id="copyBtn"
            class="w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors"
          >
            ğŸ“‹ Copiar Base64
          </button>
        </div>

        <!-- Error -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
          <h3 class="font-bold text-red-900 mb-2">âŒ Error</h3>
          <p id="errorMessage" class="text-sm text-red-800"></p>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-purple-50 border border-purple-200 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 border-4 border-purple-300 border-t-purple-600 rounded-full animate-spin"></div>
            <span class="text-purple-900 font-medium">Procesando imagen...</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Instrucciones -->
    <div class="mt-6 bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-lg font-bold text-slate-800 mb-3">ğŸ“‹ Instrucciones</h2>
      <ol class="space-y-2 text-sm text-slate-600">
        <li><strong>1.</strong> Selecciona una imagen de tu dispositivo</li>
        <li><strong>2.</strong> Revisa la informaciÃ³n original</li>
        <li><strong>3.</strong> Click en "Comprimir y Convertir"</li>
        <li><strong>4.</strong> Verifica el resultado y la compresiÃ³n</li>
        <li><strong>5.</strong> Copia el Base64 si necesitas probarlo</li>
      </ol>
      
      <div class="mt-4 p-3 bg-blue-50 rounded-lg">
        <p class="text-xs text-blue-800">
          <strong>ğŸ’¡ Nota:</strong> El lÃ­mite es 1MB. Si la imagen excede este tamaÃ±o,
          se comprimirÃ¡ automÃ¡ticamente reduciendo la calidad hasta alcanzar el lÃ­mite.
        </p>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const imageInfo = document.getElementById('imageInfo');
    const originalPreview = document.getElementById('originalPreview');
    const result = document.getElementById('result');
    const error = document.getElementById('error');
    const loading = document.getElementById('loading');

    let selectedFile = null;

    // Cuando se selecciona un archivo
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      selectedFile = file;

      // Mostrar informaciÃ³n
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatBytes(file.size);
      document.getElementById('fileType').textContent = file.type;

      // Cargar imagen para obtener dimensiones
      const img = await createImageFromFile(file);
      document.getElementById('fileDimensions').textContent = `${img.width}x${img.height}px`;

      // Mostrar preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('originalImage').src = e.target.result;
      };
      reader.readAsDataURL(file);

      // Mostrar secciones
      imageInfo.classList.remove('hidden');
      originalPreview.classList.remove('hidden');
      processBtn.disabled = false;

      // Ocultar resultado y error previos
      result.classList.add('hidden');
      error.classList.add('hidden');
    });

    // Procesar imagen
    processBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      try {
        // Mostrar loading
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        error.classList.add('hidden');

        // Procesar imagen
        const startTime = Date.now();
        const base64 = await uploadPhotoMessage(selectedFile);
        const processingTime = Date.now() - startTime;

        // Calcular tamaÃ±o del Base64
        const base64Size = getBase64Size(base64);
        const compressionRate = ((1 - base64Size / selectedFile.size) * 100).toFixed(1);

        // Obtener dimensiones finales
        const compressedImg = await createImageFromBase64(base64);

        // Mostrar resultado
        document.getElementById('finalSize').textContent = formatBytes(base64Size);
        document.getElementById('finalDimensions').textContent = `${compressedImg.width}x${compressedImg.height}px`;
        document.getElementById('finalQuality').textContent = 'AutomÃ¡tica (0.3-0.8)';
        document.getElementById('compressionRate').textContent = `${compressionRate}% reducciÃ³n`;
        document.getElementById('base64Length').textContent = base64.length.toLocaleString() + ' caracteres';
        document.getElementById('compressedImage').src = base64;

        // Guardar base64 para copiar
        window.currentBase64 = base64;

        // Mostrar resultado
        loading.classList.add('hidden');
        result.classList.remove('hidden');

        console.log('âœ… Procesamiento completado en', processingTime, 'ms');

      } catch (err) {
        console.error('âŒ Error:', err);
        document.getElementById('errorMessage').textContent = err.message;
        loading.classList.add('hidden');
        error.classList.remove('hidden');
      }
    });

    // Copiar Base64
    document.getElementById('copyBtn').addEventListener('click', () => {
      if (window.currentBase64) {
        navigator.clipboard.writeText(window.currentBase64);
        alert('âœ… Base64 copiado al portapapeles');
      }
    });

    // ============================================
    // FUNCIONES DE PROCESAMIENTO
    // ============================================

    async function uploadPhotoMessage(file, maxWidth = 1200, quality = 0.8) {
      console.log('ğŸ“¸ Procesando imagen...', {
        name: file.name,
        size: file.size,
        sizeKB: (file.size / 1024).toFixed(2) + 'KB',
        type: file.type
      });

      // Verificar que sea una imagen
      if (!file.type.startsWith('image/')) {
        throw new Error('El archivo debe ser una imagen');
      }

      // Crear imagen desde el archivo
      const img = await createImageFromFile(file);
      
      // Calcular nuevas dimensiones manteniendo aspect ratio
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      console.log('ğŸ“ Dimensiones:', {
        original: `${img.width}x${img.height}`,
        final: `${Math.round(width)}x${Math.round(height)}`
      });
      
      // Crear canvas y comprimir
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        throw new Error('No se pudo crear contexto de canvas');
      }
      
      // Dibujar imagen redimensionada
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convertir a Base64 con compresiÃ³n
      let base64String = canvas.toDataURL('image/jpeg', quality);
      let base64Size = getBase64Size(base64String);
      
      console.log('ğŸ—œï¸ Primera compresiÃ³n:', {
        sizeKB: (base64Size / 1024).toFixed(2) + 'KB',
        quality: quality
      });
      
      // Si aÃºn es muy grande, reducir calidad progresivamente
      const MAX_SIZE = 1024 * 1024; // 1MB
      let currentQuality = quality;
      
      while (base64Size > MAX_SIZE && currentQuality > 0.3) {
        currentQuality -= 0.1;
        base64String = canvas.toDataURL('image/jpeg', currentQuality);
        base64Size = getBase64Size(base64String);
        
        console.log('ğŸ—œï¸ Recomprimiendo:', {
          sizeKB: (base64Size / 1024).toFixed(2) + 'KB',
          quality: currentQuality.toFixed(1)
        });
      }
      
      // Verificar tamaÃ±o final
      if (base64Size > MAX_SIZE) {
        const sizeMB = (base64Size / (1024 * 1024)).toFixed(2);
        throw new Error(
          `La imagen es demasiado grande (${sizeMB}MB) incluso despuÃ©s de comprimir.\n\n` +
          `Por favor, selecciona una imagen mÃ¡s pequeÃ±a.`
        );
      }
      
      console.log('âœ… Imagen procesada exitosamente:', {
        finalSizeKB: (base64Size / 1024).toFixed(2) + 'KB',
        finalQuality: currentQuality.toFixed(1),
        compression: ((1 - base64Size / file.size) * 100).toFixed(1) + '%'
      });
      
      return base64String;
    }

    function createImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('Error cargando imagen'));
        };
        
        img.src = url;
      });
    }

    function createImageFromBase64(base64) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Error cargando imagen desde Base64'));
        
        img.src = base64;
      });
    }

    function getBase64Size(base64String) {
      const base64Data = base64String.split(',')[1] || base64String;
      const padding = (base64Data.match(/=/g) || []).length;
      return (base64Data.length * 3) / 4 - padding;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
  </script>

</body>
</html>
